<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QIE Bell/CHSH Simulator (Poisson)</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#111a33; --panel2:#0f1730;
      --text:#e7ecff; --muted:#a9b4e6;
      --accent:#7aa2ff; --good:#4ade80; --warn:#fbbf24; --bad:#fb7185;
      --line:#2a3b73; --chip:#16214a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(180deg, #060916 0%, var(--bg) 60%, #060916 100%);
      color:var(--text);
    }
    header{
      padding:16px 18px;
      border-bottom:1px solid rgba(122,162,255,0.18);
      background: rgba(9,13,28,0.65);
      position: sticky; top:0; backdrop-filter: blur(8px);
      z-index: 5;
    }
    header h1{margin:0; font-size:16px; letter-spacing:0.2px}
    header p{margin:6px 0 0 0; color:var(--muted); font-size:12.5px}

    .wrap{max-width:1200px; margin:0 auto; padding:16px 18px 28px}
    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1.4fr 1fr;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      background: linear-gradient(180deg, rgba(17,26,51,0.92) 0%, rgba(15,23,48,0.88) 100%);
      border:1px solid rgba(122,162,255,0.16);
      border-radius:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid rgba(122,162,255,0.12);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .card .hd .title{font-weight:600; font-size:13.5px}
    .card .bd{padding:14px}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .col{flex:1 1 240px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input[type="range"]{width:100%}
    input[type="number"]{
      width:100%; padding:9px 10px; border-radius:10px;
      border:1px solid rgba(122,162,255,0.18);
      background: rgba(5,8,18,0.55);
      color:var(--text);
      outline:none;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px;
      background: rgba(22,33,74,0.8);
      border:1px solid rgba(122,162,255,0.14);
      color:var(--muted);
      font-size:12px;
      white-space: nowrap;
    }
    .btn{
      cursor:pointer;
      border:none;
      padding:10px 12px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(122,162,255,0.95) 0%, rgba(92,130,255,0.85) 100%);
      color:#06102a;
      font-weight:700;
      font-size:12.5px;
      box-shadow: 0 10px 18px rgba(122,162,255,0.18);
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      background: rgba(5,8,18,0.55);
      color: var(--text);
      border: 1px solid rgba(122,162,255,0.18);
      box-shadow:none;
    }
    .btn.danger{
      background: rgba(251,113,133,0.16);
      color: var(--text);
      border:1px solid rgba(251,113,133,0.35);
      box-shadow:none;
    }

    .kpis{
      display:grid; gap:10px;
      grid-template-columns: repeat(3, 1fr);
    }
    @media (max-width: 980px){
      .kpis{grid-template-columns: repeat(2, 1fr);}
    }
    .kpi{
      padding:10px 12px;
      border-radius:12px;
      background: rgba(5,8,18,0.45);
      border:1px solid rgba(122,162,255,0.14);
    }
    .kpi .k{font-size:11px; color:var(--muted)}
    .kpi .v{font-size:18px; font-weight:800; margin-top:4px}
    .kpi .s{font-size:11px; color:var(--muted); margin-top:4px}

    table{width:100%; border-collapse: collapse; font-size:12px}
    th, td{padding:8px 8px; border-bottom:1px solid rgba(122,162,255,0.10); text-align:left}
    th{color:var(--muted); font-weight:600}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .tag{
      display:inline-block; padding:3px 8px; border-radius:999px;
      font-size:11px; background: rgba(122,162,255,0.12);
      border:1px solid rgba(122,162,255,0.20); color:var(--muted);
    }
    .status{
      font-weight:800;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(5,8,18,0.45);
    }
    .status.good{border-color: rgba(74,222,128,0.38); color: var(--good)}
    .status.bad{border-color: rgba(251,113,133,0.45); color: var(--bad)}
    .status.warn{border-color: rgba(251,191,36,0.45); color: var(--warn)}
    .hint{color:var(--muted); font-size:12px; line-height:1.4}
    .small{font-size:11px; color:var(--muted)}
    .sep{height:1px; background: rgba(122,162,255,0.10); margin:10px 0}

    /* SVG look */
    .schem{
      width:100%;
      height:auto;
      display:block;
      background: radial-gradient(1200px 400px at 20% 20%, rgba(122,162,255,0.10), transparent 60%),
                  radial-gradient(1000px 380px at 80% 65%, rgba(251,113,133,0.08), transparent 60%),
                  rgba(5,8,18,0.35);
      border-radius: 12px;
      border:1px solid rgba(122,162,255,0.12);
    }
  </style>
</head>
<body>
<header>
  <h1>QIE Bell / CHSH Simulator — Poisson coincidences + “beam path” UI</h1>
  <p>Adjust HWP + QP + analyzers. Take VV/HV/VH/HH counts, compute E(α,β), and run a CHSH S measurement with Poisson noise + background.</p>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: Beam path schematic -->
    <div class="card">
      <div class="hd">
        <div class="title">Beam path (schematic UI)</div>
        <div class="chip mono" id="schemLabel">HWP: 22.50° · QP: 0.0° → φ=0.00 rad · α: -45.0° · β: -22.5°</div>
      </div>
      <div class="bd">
        <svg class="schem" viewBox="0 0 980 360" aria-label="Beam path schematic">
          <!-- safety enclosure -->
          <rect x="40" y="70" width="690" height="220" rx="10"
                fill="rgba(17,26,51,0.35)" stroke="rgba(122,162,255,0.25)" stroke-width="2"/>
          <text x="545" y="92" fill="rgba(231,236,255,0.9)" font-size="14" font-weight="700">safety enclosure</text>

          <!-- purple 405 nm vertical beam -->
          <line x1="110" y1="90" x2="110" y2="255"
                stroke="rgba(190,120,255,0.95)" stroke-width="3" stroke-dasharray="6 6"/>
          <text x="78" y="185" fill="rgba(190,120,255,0.95)" font-size="12" transform="rotate(-90 78,185)">
            405 nm beam
          </text>

          <!-- laser diode + lens -->
          <rect x="92" y="80" width="36" height="18" rx="4" fill="rgba(190,120,255,0.25)" stroke="rgba(190,120,255,0.65)"/>
          <text x="140" y="95" fill="rgba(231,236,255,0.9)" font-size="12">laser diode</text>
          <ellipse cx="110" cy="125" rx="14" ry="7" fill="rgba(231,236,255,0.08)" stroke="rgba(231,236,255,0.35)"/>
          <text x="140" y="130" fill="rgba(231,236,255,0.9)" font-size="12">lens (focuses at BBO)</text>

          <!-- mirror -->
          <line x1="85" y1="260" x2="135" y2="230" stroke="rgba(231,236,255,0.75)" stroke-width="4"/>
          <text x="52" y="285" fill="rgba(231,236,255,0.85)" font-size="12" transform="rotate(-35 52,285)">mirror</text>

          <!-- purple horizontal beam from mirror to BBO -->
          <line x1="110" y1="245" x2="330" y2="245"
                stroke="rgba(190,120,255,0.95)" stroke-width="3" stroke-dasharray="6 6"/>

          <!-- HWP element -->
          <rect x="190" y="226" width="16" height="40" fill="rgba(231,236,255,0.10)" stroke="rgba(231,236,255,0.55)"/>
          <text x="178" y="220" fill="rgba(231,236,255,0.9)" font-size="12">HWP</text>
          <text x="168" y="275" fill="rgba(122,162,255,0.95)" font-size="11" font-weight="700" id="hwpText">22.50°</text>

          <!-- QP element -->
          <rect x="260" y="226" width="10" height="40" fill="rgba(231,236,255,0.08)" stroke="rgba(231,236,255,0.45)"/>
          <text x="252" y="220" fill="rgba(231,236,255,0.9)" font-size="12">QP</text>
          <text x="242" y="275" fill="rgba(122,162,255,0.95)" font-size="11" font-weight="700" id="qpText">0.0°</text>

          <!-- BBO crystal + iris -->
          <rect x="360" y="225" width="22" height="42" fill="rgba(122,162,255,0.20)" stroke="rgba(122,162,255,0.65)"/>
          <text x="348" y="210" fill="rgba(231,236,255,0.9)" font-size="12">BBO crystal</text>
          <rect x="410" y="232" width="8" height="28" fill="rgba(231,236,255,0.12)" stroke="rgba(231,236,255,0.45)"/>
          <text x="404" y="210" fill="rgba(231,236,255,0.9)" font-size="12">iris</text>

          <!-- red 808 nm cone beams -->
          <line x1="382" y1="245" x2="740" y2="205"
                stroke="rgba(255,90,90,0.90)" stroke-width="2.8" stroke-dasharray="8 6"/>
          <line x1="382" y1="245" x2="740" y2="285"
                stroke="rgba(255,90,90,0.90)" stroke-width="2.8" stroke-dasharray="8 6"/>
          <text x="485" y="232" fill="rgba(255,140,140,0.95)" font-size="12">808 nm cone (~6°)</text>

          <!-- beam stop -->
          <path d="M620 255 q 25 20 55 10" fill="none" stroke="rgba(0,0,0,0.7)" stroke-width="10" stroke-linecap="round"/>
          <text x="603" y="298" fill="rgba(231,236,255,0.9)" font-size="12">Beam Stop</text>

          <!-- detector-side optics -->
          <text x="760" y="170" fill="rgba(231,236,255,0.9)" font-size="12">longpass filter</text>
          <rect x="745" y="178" width="10" height="52" fill="rgba(231,236,255,0.12)" stroke="rgba(231,236,255,0.45)"/>
          <text x="770" y="220" fill="rgba(231,236,255,0.9)" font-size="12">polarizer</text>

          <!-- polarizers (two arms) -->
          <rect x="790" y="190" width="8" height="30" fill="rgba(231,236,255,0.10)" stroke="rgba(231,236,255,0.55)"/>
          <rect x="790" y="255" width="8" height="30" fill="rgba(231,236,255,0.10)" stroke="rgba(231,236,255,0.55)"/>
          <text x="806" y="205" fill="rgba(122,162,255,0.95)" font-size="11" font-weight="700" id="alphaText">α=-45.0°</text>
          <text x="806" y="270" fill="rgba(122,162,255,0.95)" font-size="11" font-weight="700" id="betaText">β=-22.5°</text>

          <!-- iris and lens -->
          <rect x="812" y="198" width="6" height="16" fill="rgba(231,236,255,0.12)" stroke="rgba(231,236,255,0.45)"/>
          <rect x="812" y="263" width="6" height="16" fill="rgba(231,236,255,0.12)" stroke="rgba(231,236,255,0.45)"/>
          <ellipse cx="840" cy="206" rx="10" ry="6" fill="rgba(231,236,255,0.08)" stroke="rgba(231,236,255,0.35)"/>
          <ellipse cx="840" cy="271" rx="10" ry="6" fill="rgba(231,236,255,0.08)" stroke="rgba(231,236,255,0.35)"/>
          <text x="854" y="208" fill="rgba(231,236,255,0.8)" font-size="11">iris · lens</text>

          <!-- fibres and APD box -->
          <path d="M852 206 C 900 190, 920 160, 940 130" fill="none" stroke="rgba(231,236,255,0.45)" stroke-width="2"/>
          <path d="M852 271 C 900 285, 920 305, 940 320" fill="none" stroke="rgba(231,236,255,0.45)" stroke-width="2"/>
          <rect x="910" y="110" width="62" height="56" rx="8"
                fill="rgba(0,0,0,0.70)" stroke="rgba(255,220,120,0.55)" stroke-width="2"/>
          <text x="922" y="135" fill="rgba(255,220,120,0.95)" font-size="12" font-weight="800">APD</text>
          <text x="922" y="152" fill="rgba(255,220,120,0.95)" font-size="12" font-weight="800">Detector</text>
          <text x="882" y="124" fill="rgba(231,236,255,0.8)" font-size="11">fibre</text>
          <text x="882" y="138" fill="rgba(231,236,255,0.8)" font-size="11">optics</text>

          <!-- readout arrow -->
          <line x1="910" y1="108" x2="260" y2="60" stroke="rgba(231,236,255,0.55)" stroke-width="2" marker-end="url(#arrow)"/>
          <text x="330" y="52" fill="rgba(231,236,255,0.8)" font-size="12">to readout board and computer</text>

          <defs>
            <marker id="arrow" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto">
              <path d="M0,0 L10,4 L0,8 Z" fill="rgba(231,236,255,0.55)"></path>
            </marker>
          </defs>
        </svg>

        <div class="sep"></div>
        <div class="hint">
          This schematic is just a UI metaphor: the “physics” is simulated using the state
          <span class="mono">cos(θ)|HH⟩ + e^{iφ} sin(θ)|VV⟩</span>,
          coincidences are sampled as <span class="mono">Poisson( R_pair·T·P_VV + R_bg·T )</span>,
          and <span class="mono">E</span>, <span class="mono">S</span> are computed from the four (or sixteen) settings.
        </div>
      </div>
    </div>

    <!-- RIGHT: Controls + results -->
    <div class="card">
      <div class="hd">
        <div class="title">Controls & measurements</div>
        <div class="row">
          <button class="btn secondary" id="btnReset">Reset</button>
          <button class="btn danger" id="btnClear">Clear log</button>
        </div>
      </div>
      <div class="bd">
        <div class="row">
          <div class="col">
            <label>HWP angle (deg) → θ = 2·HWP (deg)</label>
            <input type="range" min="0" max="45" step="0.01" id="hwpDeg" />
            <div class="small mono" id="hwpReadout"></div>
          </div>
          <div class="col">
            <label>QP tilt (deg) → φ = φ0 + k·(tilt)</label>
            <input type="range" min="-20" max="20" step="0.01" id="qpDeg" />
            <div class="small mono" id="qpReadout"></div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Analyzer α (deg)</label>
            <input type="range" min="-90" max="90" step="0.1" id="alphaDeg" />
            <div class="small mono" id="alphaReadout"></div>
          </div>
          <div class="col">
            <label>Analyzer β (deg)</label>
            <input type="range" min="-90" max="90" step="0.1" id="betaDeg" />
            <div class="small mono" id="betaReadout"></div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Pair rate R<sub>pair</sub> (Hz)</label>
            <input type="number" id="pairRate" />
          </div>
          <div class="col">
            <label>Background rate R<sub>bg</sub> (Hz)</label>
            <input type="number" id="bgRate" />
          </div>
          <div class="col">
            <label>Integration time T (s)</label>
            <input type="number" id="timeS" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Visibility (0–1) (simple imperfection knob)</label>
            <input type="range" min="0" max="1" step="0.001" id="vis" />
            <div class="small mono" id="visReadout"></div>
          </div>
          <div class="col">
            <label>RNG seed (integer; same seed → repeatable)</label>
            <input type="number" id="seed" />
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <button class="btn" id="btnMeasureVV">Measure N(α,β) (VV)</button>
          <button class="btn" id="btnMeasureE">Measure E(α,β) (VV/HH/HV/VH)</button>
          <button class="btn" id="btnMeasureS">Run CHSH S (a,a′,b,b′)</button>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="chip">CHSH defaults: a=-45°, a′=0°, b=-22.5°, b′=+22.5°</div>
          <div class="chip">You can still move α,β for single E(α,β) runs</div>
        </div>

        <div class="sep"></div>

        <div class="kpis">
          <div class="kpi">
            <div class="k">Theoretical S (noise-free)</div>
            <div class="v mono" id="kpiSth">—</div>
            <div class="s small">From E formula (no Poisson)</div>
          </div>
          <div class="kpi">
            <div class="k">Last measured S</div>
            <div class="v mono" id="kpiSmeas">—</div>
            <div class="s small" id="kpiSstatus">—</div>
          </div>
          <div class="kpi">
            <div class="k">Last measurement</div>
            <div class="v mono" id="kpiLast">—</div>
            <div class="s small" id="kpiLast2">—</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="hint">
          <b>Notes:</b> “VV” here means both analyzers project onto their transmission axes (angles α, β).
          The other configurations are generated by +90° rotations, and the E estimator uses the manual-style
          background correction with <span class="mono">-4C</span> in the denominator.
        </div>
      </div>
    </div>

    <!-- FULL WIDTH: Log -->
    <div class="card" style="grid-column: 1 / -1;">
      <div class="hd">
        <div class="title">Measurement log</div>
        <div class="row">
          <button class="btn secondary" id="btnExport">Export log (JSON)</button>
        </div>
      </div>
      <div class="bd">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Type</th>
              <th>Settings</th>
              <th>Counts / E / S</th>
              <th>Params</th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
        <div class="small" style="margin-top:8px">
          Tip: Set a seed (e.g. 1) to make the Monte Carlo repeatable; clear the log to start fresh.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ---------- utilities ----------
  const DEG = Math.PI / 180;
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const fmt = (x, d=4)=> (Number.isFinite(x) ? x.toFixed(d) : "NaN");

  // seeded PRNG (mulberry32)
  function mulberry32(seed){
    let t = seed >>> 0;
    return function(){
      t += 0x6D2B79F5;
      let r = Math.imul(t ^ (t >>> 15), 1 | t);
      r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
      return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
    };
  }
  function boxMuller(rand){
    // standard normal
    let u = 0, v = 0;
    while(u === 0) u = rand();
    while(v === 0) v = rand();
    return Math.sqrt(-2*Math.log(u)) * Math.cos(2*Math.PI*v);
  }
  function poisson(lam, rand){
    if(lam <= 0) return 0;
    if(lam < 30){
      // Knuth
      const L = Math.exp(-lam);
      let k = 0;
      let p = 1;
      do {
        k++;
        p *= rand();
      } while(p > L);
      return k - 1;
    } else {
      // Normal approximation for speed/stability
      const x = lam + Math.sqrt(lam) * boxMuller(rand);
      return Math.max(0, Math.round(x));
    }
  }

  // ---------- physics model ----------
  function P_VV(alpha, beta, theta, phi, visibility){
    const sa = Math.sin(alpha), ca = Math.cos(alpha);
    const sb = Math.sin(beta),  cb = Math.cos(beta);
    const st = Math.sin(theta), ct = Math.cos(theta);

    const term1 = (sa*sa) * (sb*sb) * (ct*ct);
    const term2 = (ca*ca) * (cb*cb) * (st*st);
    const inter = 0.25 * Math.sin(2*alpha) * Math.sin(2*beta) * Math.sin(2*theta) * Math.cos(phi);

    const p = term1 + term2 + visibility * inter;
    return clamp(p, 0.0, 1.0);
  }

  function E_theory(alpha, beta, theta, phi){
    // compact closed form correlation
    return (Math.cos(2*alpha)*Math.cos(2*beta) + Math.sin(2*theta)*Math.sin(2*alpha)*Math.sin(2*beta)*Math.cos(phi));
  }

  function measure_counts(alpha, beta, theta, phi, pairRate, T, bgRate, visibility, rand){
    const meanSignal = pairRate * T * P_VV(alpha, beta, theta, phi, visibility);
    const meanBg = bgRate * T;
    return { N: poisson(meanSignal + meanBg, rand), mean: meanSignal + meanBg, meanSignal, meanBg };
  }

  function measure_E(alpha, beta, theta, phi, pairRate, T, bgRate, visibility, rand){
    // VV, HH, HV, VH using +90° mapping
    const VV = measure_counts(alpha,            beta,            theta, phi, pairRate, T, bgRate, visibility, rand);
    const HH = measure_counts(alpha + Math.PI/2,beta + Math.PI/2,theta, phi, pairRate, T, bgRate, visibility, rand);
    const HV = measure_counts(alpha + Math.PI/2,beta,            theta, phi, pairRate, T, bgRate, visibility, rand);
    const VH = measure_counts(alpha,            beta + Math.PI/2,theta, phi, pairRate, T, bgRate, visibility, rand);

    const C = bgRate * T;
    const num = (VV.N + HH.N - HV.N - VH.N);
    const den = (VV.N + HH.N + HV.N + VH.N - 4*C);
    const E = (den > 0) ? (num / den) : NaN;

    return { E, C, counts: {VV, HH, HV, VH}, num, den };
  }

  function measure_S(theta, phi, pairRate, T, bgRate, visibility, rand){
    // CHSH defaults
    const a   = -45 * DEG;
    const ap  =   0 * DEG;
    const b   = -22.5 * DEG;
    const bp  = +22.5 * DEG;

    const Eab   = measure_E(a,  b,  theta, phi, pairRate, T, bgRate, visibility, rand);
    const Eabp  = measure_E(a,  bp, theta, phi, pairRate, T, bgRate, visibility, rand);
    const Eapb  = measure_E(ap, b,  theta, phi, pairRate, T, bgRate, visibility, rand);
    const Eapbp = measure_E(ap, bp, theta, phi, pairRate, T, bgRate, visibility, rand);

    const S = Eab.E - Eabp.E + Eapb.E + Eapbp.E;

    const Sth =
      E_theory(a,b,theta,phi) - E_theory(a,bp,theta,phi) + E_theory(ap,b,theta,phi) + E_theory(ap,bp,theta,phi);

    return { S, Sth, Es: { "ab": Eab, "ab'": Eabp, "a'b": Eapb, "a'b'": Eapbp } };
  }

  // ---------- UI state ----------
  const el = (id)=>document.getElementById(id);

  const ui = {
    hwpDeg: el("hwpDeg"),
    qpDeg: el("qpDeg"),
    alphaDeg: el("alphaDeg"),
    betaDeg: el("betaDeg"),
    pairRate: el("pairRate"),
    bgRate: el("bgRate"),
    timeS: el("timeS"),
    vis: el("vis"),
    seed: el("seed"),

    hwpReadout: el("hwpReadout"),
    qpReadout: el("qpReadout"),
    alphaReadout: el("alphaReadout"),
    betaReadout: el("betaReadout"),
    visReadout: el("visReadout"),

    hwpText: el("hwpText"),
    qpText: el("qpText"),
    alphaText: el("alphaText"),
    betaText: el("betaText"),
    schemLabel: el("schemLabel"),

    kpiSth: el("kpiSth"),
    kpiSmeas: el("kpiSmeas"),
    kpiSstatus: el("kpiSstatus"),
    kpiLast: el("kpiLast"),
    kpiLast2: el("kpiLast2"),

    logBody: el("logBody"),

    btnMeasureVV: el("btnMeasureVV"),
    btnMeasureE: el("btnMeasureE"),
    btnMeasureS: el("btnMeasureS"),
    btnReset: el("btnReset"),
    btnClear: el("btnClear"),
    btnExport: el("btnExport"),
  };

  let log = [];

  function getParams(){
    const hwpDeg = parseFloat(ui.hwpDeg.value);
    const qpDeg  = parseFloat(ui.qpDeg.value);
    const alphaDeg = parseFloat(ui.alphaDeg.value);
    const betaDeg  = parseFloat(ui.betaDeg.value);

    // simple mapping knobs → state parameters
    const theta = (2 * hwpDeg) * DEG;         // θ = 2·HWP
    const k = 0.12;                            // rad/deg (tune to taste)
    const phi0 = 0.0;
    const phi = phi0 + k * qpDeg;              // φ = φ0 + k·tilt

    const pairRate = parseFloat(ui.pairRate.value);
    const bgRate = parseFloat(ui.bgRate.value);
    const T = parseFloat(ui.timeS.value);
    const visibility = parseFloat(ui.vis.value);

    const seed = parseInt(ui.seed.value || "1", 10);

    return {
      hwpDeg, qpDeg, alphaDeg, betaDeg,
      theta, phi,
      alpha: alphaDeg*DEG, beta: betaDeg*DEG,
      pairRate, bgRate, T, visibility, seed
    };
  }

  function setKpiStatus(S){
    const absS = Math.abs(S);
    if(!Number.isFinite(S)) return {cls:"warn", text:"S is NaN (try higher T, lower bg)"};
    if(absS > 2.0) return {cls:"good", text:"Bell violation: |S| > 2"};
    if(absS > 1.7) return {cls:"warn", text:"Near threshold: |S| close to 2"};
    return {cls:"bad", text:"No violation: |S| ≤ 2"};
  }

  function render(){
    const p = getParams();

    ui.hwpReadout.textContent = `HWP = ${p.hwpDeg.toFixed(2)}°  →  θ = ${(p.theta/DEG).toFixed(2)}° (${fmt(p.theta,4)} rad)`;
    ui.qpReadout.textContent  = `QP tilt = ${p.qpDeg.toFixed(2)}°  →  φ = ${fmt(p.phi,4)} rad`;
    ui.alphaReadout.textContent = `α = ${p.alphaDeg.toFixed(1)}°`;
    ui.betaReadout.textContent  = `β = ${p.betaDeg.toFixed(1)}°`;
    ui.visReadout.textContent = `visibility = ${p.visibility.toFixed(3)}`;

    ui.hwpText.textContent = `${p.hwpDeg.toFixed(2)}°`;
    ui.qpText.textContent  = `${p.qpDeg.toFixed(1)}°`;
    ui.alphaText.textContent = `α=${p.alphaDeg.toFixed(1)}°`;
    ui.betaText.textContent  = `β=${p.betaDeg.toFixed(1)}°`;

    ui.schemLabel.textContent =
      `HWP: ${p.hwpDeg.toFixed(2)}° · QP: ${p.qpDeg.toFixed(1)}° → φ=${p.phi.toFixed(2)} rad · α: ${p.alphaDeg.toFixed(1)}° · β: ${p.betaDeg.toFixed(1)}°`;

    // theoretical S for the current HWP/QP (using CHSH default angles)
    const a=-45*DEG, ap=0*DEG, b=-22.5*DEG, bp=+22.5*DEG;
    const Sth = E_theory(a,b,p.theta,p.phi) - E_theory(a,bp,p.theta,p.phi) + E_theory(ap,b,p.theta,p.phi) + E_theory(ap,bp,p.theta,p.phi);
    ui.kpiSth.textContent = fmt(Sth, 4);

    // log table
    ui.logBody.innerHTML = log.slice().reverse().map((r, idx) => {
      const i = log.length - idx;
      return `
        <tr>
          <td class="mono">${i}</td>
          <td><span class="tag">${r.type}</span></td>
          <td class="mono">${r.settings}</td>
          <td class="mono">${r.result}</td>
          <td class="mono">${r.params}</td>
        </tr>
      `;
    }).join("");
  }

  function pushLog(entry){
    log.push(entry);
    if(log.length > 250) log = log.slice(-250);
    render();
  }

  function runMeasureVV(){
    const p = getParams();
    const rand = mulberry32(p.seed + log.length * 1337);

    const m = measure_counts(p.alpha, p.beta, p.theta, p.phi, p.pairRate, p.T, p.bgRate, p.visibility, rand);

    ui.kpiLast.textContent = `N(VV) = ${m.N}`;
    ui.kpiLast2.textContent = `mean≈${m.mean.toFixed(2)} (signal≈${m.meanSignal.toFixed(2)}, bg≈${m.meanBg.toFixed(2)})`;

    pushLog({
      type: "VV",
      settings: `α=${p.alphaDeg.toFixed(1)}°, β=${p.betaDeg.toFixed(1)}°`,
      result: `N=${m.N} (mean≈${m.mean.toFixed(2)})`,
      params: `Rpair=${p.pairRate}, Rbg=${p.bgRate}, T=${p.T}, vis=${p.visibility.toFixed(3)}, seed=${p.seed}`
    });
  }

  function runMeasureE(){
    const p = getParams();
    const rand = mulberry32(p.seed + log.length * 1337);

    const out = measure_E(p.alpha, p.beta, p.theta, p.phi, p.pairRate, p.T, p.bgRate, p.visibility, rand);

    const VV = out.counts.VV.N, HH = out.counts.HH.N, HV = out.counts.HV.N, VH = out.counts.VH.N;

    ui.kpiLast.textContent = `E(α,β) = ${fmt(out.E,4)}`;
    ui.kpiLast2.textContent = `VV=${VV}, HH=${HH}, HV=${HV}, VH=${VH}, C=${out.C.toFixed(2)}`;

    pushLog({
      type: "E",
      settings: `α=${p.alphaDeg.toFixed(1)}°, β=${p.betaDeg.toFixed(1)}°`,
      result: `E=${fmt(out.E,4)} | VV=${VV},HH=${HH},HV=${HV},VH=${VH} | den=${out.den.toFixed(2)}`,
      params: `Rpair=${p.pairRate}, Rbg=${p.bgRate}, T=${p.T}, vis=${p.visibility.toFixed(3)}, seed=${p.seed}`
    });
  }

  function runMeasureS(){
    const p = getParams();
    const rand = mulberry32(p.seed + log.length * 1337);

    const out = measure_S(p.theta, p.phi, p.pairRate, p.T, p.bgRate, p.visibility, rand);

    ui.kpiSmeas.textContent = fmt(out.S, 4);

    const st = setKpiStatus(out.S);
    ui.kpiSstatus.innerHTML = `<span class="status ${st.cls}">${st.text}</span>`;

    const Es = out.Es;
    ui.kpiLast.textContent = `CHSH run complete`;
    ui.kpiLast2.textContent = `Eab=${fmt(Es["ab"].E,3)}, Eab'=${fmt(Es["ab'"].E,3)}, Ea'b=${fmt(Es["a'b"].E,3)}, Ea'b'=${fmt(Es["a'b'"].E,3)}`;

    pushLog({
      type: "S",
      settings: `HWP=${p.hwpDeg.toFixed(2)}° → θ=${(p.theta/DEG).toFixed(2)}°; QP=${p.qpDeg.toFixed(1)}° → φ=${p.phi.toFixed(3)}rad`,
      result: `S=${fmt(out.S,4)} (theory=${fmt(out.Sth,4)})`,
      params: `Rpair=${p.pairRate}, Rbg=${p.bgRate}, T=${p.T}, vis=${p.visibility.toFixed(3)}, seed=${p.seed}`
    });
  }

  function reset(){
    ui.hwpDeg.value = "22.50";    // Bell-ish: θ=45°
    ui.qpDeg.value = "0.0";       // φ≈0
    ui.alphaDeg.value = "-45.0";
    ui.betaDeg.value  = "-22.5";
    ui.pairRate.value = "5000";
    ui.bgRate.value   = "20";
    ui.timeS.value    = "1.0";
    ui.vis.value      = "1.0";
    ui.seed.value     = "1";

    ui.kpiSmeas.textContent = "—";
    ui.kpiSstatus.textContent = "—";
    ui.kpiLast.textContent = "—";
    ui.kpiLast2.textContent = "—";
    render();
  }

  function clearLog(){
    log = [];
    render();
  }

  function exportLog(){
    const blob = new Blob([JSON.stringify(log, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "qie_sim_log.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  // wire events
  ["hwpDeg","qpDeg","alphaDeg","betaDeg","pairRate","bgRate","timeS","vis","seed"].forEach(id=>{
    el(id).addEventListener("input", render);
  });
  ui.btnMeasureVV.addEventListener("click", runMeasureVV);
  ui.btnMeasureE.addEventListener("click", runMeasureE);
  ui.btnMeasureS.addEventListener("click", runMeasureS);
  ui.btnReset.addEventListener("click", reset);
  ui.btnClear.addEventListener("click", clearLog);
  ui.btnExport.addEventListener("click", exportLog);

  reset();
</script>
</body>
</html>